{% extends "base.html" %}
{% block title %}Code Classroom | Task List{% endblock %}
{% block main %}

<div class="pageTitleDiv"><h1>{{page.title()}}</h1></div>
<div class="taskListContainer">
    <div class="taskSummaryContainerTaskList" id="taskSummaryContainerTaskList">
        <div class="taskSummaryTitleTextContainer">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5.05409 9.17885C5.19701 9.27977 5.36734 9.33343 5.54176 9.33285V9.33052C5.70641 9.33079 5.86752 9.28275 6.00512 9.19233C6.14272 9.1019 6.25076 8.97309 6.31584 8.82185L6.67343 7.73452C6.75605 7.48821 6.89482 7.2645 7.07877 7.08106C7.26272 6.89761 7.48682 6.75946 7.73334 6.67752L8.77051 6.34035C8.93758 6.28165 9.08188 6.17176 9.18288 6.02631C9.28388 5.88086 9.33645 5.70726 9.33309 5.53022C9.32973 5.35317 9.27062 5.18169 9.16417 5.04018C9.05772 4.89867 8.90935 4.79433 8.74018 4.74202L7.71643 4.40952C7.46876 4.32715 7.24372 4.18814 7.05922 4.00353C6.87471 3.81892 6.73582 3.59381 6.65359 3.3461L6.31643 2.30952C6.25763 2.14442 6.14886 2.00173 6.00524 1.90129C5.86162 1.80085 5.69028 1.74764 5.51503 1.74905C5.33978 1.75046 5.16932 1.80643 5.02734 1.90917C4.88535 2.01191 4.7789 2.15633 4.72276 2.32235L4.38268 3.36768C4.30067 3.60817 4.16513 3.8269 3.98627 4.00737C3.80742 4.18784 3.58992 4.32535 3.35018 4.40952L2.31359 4.7426C2.14743 4.80029 2.0035 4.90856 1.90199 5.05221C1.80048 5.19585 1.74648 5.36767 1.74757 5.54357C1.74867 5.71946 1.8048 5.89059 1.90809 6.03297C2.01138 6.17534 2.15664 6.28181 2.32351 6.33743L3.34668 6.66935C3.59429 6.75233 3.81922 6.89176 4.00367 7.07663C4.18813 7.26149 4.32707 7.48672 4.40951 7.73452L4.74668 8.76993C4.80443 8.93502 4.91176 9.07852 5.05409 9.17885ZM9.52651 12.1229C9.41537 12.0437 9.33176 11.9317 9.28734 11.8027L9.09601 11.2153C9.0592 11.1034 8.99671 11.0017 8.91355 10.9184C8.83038 10.835 8.72886 10.7723 8.61709 10.7352L8.03901 10.5468C7.90668 10.5021 7.79162 10.4172 7.70993 10.3039C7.62824 10.1907 7.58401 10.0547 7.58343 9.91502C7.58352 9.77626 7.6269 9.641 7.70752 9.52807C7.78814 9.41514 7.90198 9.33017 8.03318 9.28502L8.62001 9.09485C8.7291 9.05612 8.82788 8.99292 8.90877 8.91011C8.98966 8.8273 9.05052 8.72707 9.08668 8.6171L9.27568 8.03843C9.32014 7.90763 9.40414 7.79386 9.51607 7.71287C9.62799 7.63188 9.76231 7.58765 9.90046 7.5863C10.0386 7.58496 10.1738 7.62656 10.2872 7.70536C10.4007 7.78416 10.4869 7.89627 10.5339 8.02618L10.7258 8.61768C10.7634 8.72856 10.8262 8.82924 10.9091 8.91182C10.9921 8.9944 11.0931 9.05665 11.2042 9.09368L11.7828 9.2821C11.9162 9.32382 12.0331 9.40647 12.1169 9.51834C12.2007 9.63021 12.2471 9.76561 12.2497 9.90535C12.2522 10.0451 12.2106 10.1821 12.1309 10.2969C12.0512 10.4117 11.9374 10.4985 11.8056 10.545L11.2141 10.7369C11.1029 10.7745 11.0019 10.8373 10.9191 10.9205C10.8363 11.0037 10.7739 11.105 10.7369 11.2164L10.5491 11.7933C10.5036 11.9275 10.4173 12.0442 10.3012 12.1258C10.1879 12.2064 10.0523 12.2494 9.91338 12.2488C9.77443 12.2483 9.63915 12.2043 9.52651 12.1229Z" fill="url(#paint0_linear_1063_265)"/>
                <defs>
                <linearGradient id="paint0_linear_1063_265" x1="6.99866" y1="1.74902" x2="2.5" y2="11.5" gradientUnits="userSpaceOnUse">
                <stop stop-color="#FFB4D6"/>
                <stop offset="1" stop-color="#D1C7FF"/>
                </linearGradient>
                </defs>
                </svg>
            <span>Task Summary</span>  
            <p id="taskSummaryText"></p>
        </div>
        <zero-md class="markdown aiMarkdown" id="aiMarkdown">
            <template data-append>
              <link type="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
              <link type="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11/styles/github-dark.min.css">
              <style>
                  .markdown-body {
                      padding: 0px !important;
                      box-sizing: border-box !important;
                      height: auto !important;
                      width: auto !important;
                      background-color: transparent  !important;
                      border: 1px solid transparent  !important;
                      font-family: "Lexend", sans-serif !important;
                      background: none !important;
                      overflow-y: hidden !important;
                  }

                  .markdown-body p{
                    font-size: 14px !important;
                    color: #d5b8d9 !important;
                  }
                  .markdown-body > pre {
                      background-color: transparent;
                      border-radius: 16px;
                  }
                  .markdown-body code:not(pre > code) {
                      background-color: #32394b;
                      border-radius: 16px;
                      color:#e7b9a2;
                  }
              </style>
            </template>
            <script type="text/markdown" id="aiText">
            </script>
          </zero-md>
    </div>
    <a href="/enableAI" style="display: none;" id="enableAIButton" class="primaryButton"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.664 15.735c.245.173.537.265.836.264v-.004a1.442 1.442 0 0 0 1.327-.872l.613-1.864a2.872 2.872 0 0 1 1.817-1.812l1.778-.578a1.443 1.443 0 0 0-.052-2.74l-1.755-.57a2.876 2.876 0 0 1-1.822-1.823l-.578-1.777a1.446 1.446 0 0 0-2.732.022l-.583 1.792a2.877 2.877 0 0 1-1.77 1.786l-1.777.571a1.444 1.444 0 0 0 .017 2.734l1.754.569a2.887 2.887 0 0 1 1.822 1.826l.578 1.775c.099.283.283.528.527.7Zm-.374-4.25a4.054 4.054 0 0 0-.363-.413h.003a4.394 4.394 0 0 0-1.72-1.063l-1.6-.508 1.611-.524a4.4 4.4 0 0 0 1.69-1.065 4.448 4.448 0 0 0 1.041-1.708l.515-1.582.516 1.587a4.374 4.374 0 0 0 2.781 2.773l1.62.522-1.59.515a4.379 4.379 0 0 0-2.774 2.775l-.515 1.582-.515-1.585a4.368 4.368 0 0 0-.7-1.306Zm8.041 9.297a1.123 1.123 0 0 1-.41-.549l-.328-1.007a1.293 1.293 0 0 0-.821-.823l-.991-.323A1.148 1.148 0 0 1 13 16.997a1.143 1.143 0 0 1 .771-1.08l1.006-.326a1.3 1.3 0 0 0 .8-.819l.324-.992a1.143 1.143 0 0 1 2.157-.021l.329 1.014a1.3 1.3 0 0 0 .82.816l.992.323a1.141 1.141 0 0 1 .039 2.165l-1.014.329a1.3 1.3 0 0 0-.818.822l-.322.989c-.078.23-.226.43-.425.57a1.14 1.14 0 0 1-1.328-.005Zm-1.03-3.783A2.789 2.789 0 0 1 17 18.708a2.794 2.794 0 0 1 1.7-1.7 2.813 2.813 0 0 1-1.718-1.708A2.806 2.806 0 0 1 15.3 17Z" fill="#ffffff"/></svg>Enable AI Tools</a>
    <div>
        <div class="taskListTitleContainer taskListTitleContainerRed">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2c5.523 0 10 4.478 10 10s-4.477 10-10 10S2 17.522 2 12 6.477 2 12 2Zm0 1.667c-4.595 0-8.333 3.738-8.333 8.333 0 4.595 3.738 8.333 8.333 8.333 4.595 0 8.333-3.738 8.333-8.333 0-4.595-3.738-8.333-8.333-8.333Zm-.001 10.835a.999.999 0 1 1 0 1.998.999.999 0 0 1 0-1.998ZM11.994 7a.75.75 0 0 1 .744.648l.007.101.004 4.502a.75.75 0 0 1-1.493.103l-.007-.102-.004-4.501a.75.75 0 0 1 .75-.751Z" fill="#ffffff"/></svg>
            <p>Missing</p>
            <button id="missingHideButton"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.22 15.53a.75.75 0 0 0 1.06 0L12 8.81l6.72 6.72a.75.75 0 1 0 1.06-1.06l-7.25-7.25a.75.75 0 0 0-1.06 0l-7.25 7.25a.75.75 0 0 0 0 1.06Z" fill="#ffffff"/></svg></button>
        </div>
        <div id="missingTasks" class="taskListContainerTasks">

        </div>
    </div>
    <div>
        <div class="taskListTitleContainer taskListTitleContainerOrange">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2.028 11.25C2.41 6.077 6.729 2 12 2c5.27 0 9.589 4.077 9.972 9.25H22V12c0 5.523-4.477 10-10 10S2 17.523 2 12v-.75h.028ZM12 3.5a8.5 8.5 0 0 0-8.467 7.75h16.934A8.5 8.5 0 0 0 12 3.5Z" fill="#ffffff"/></svg>
            <p>This Week</p>
            <button id="thisWeekHideButton"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.22 15.53a.75.75 0 0 0 1.06 0L12 8.81l6.72 6.72a.75.75 0 1 0 1.06-1.06l-7.25-7.25a.75.75 0 0 0-1.06 0l-7.25 7.25a.75.75 0 0 0 0 1.06Z" fill="#ffffff"/></svg></button>
        </div>
        <div id="thisWeekTasks" class="taskListContainerTasks">

        </div>
    </div>
    <div>
        <div class="taskListTitleContainer taskListTitleContainerOrange">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3.5a8.5 8.5 0 1 0 0 17 8.5 8.5 0 0 0 0-17ZM2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12Z" fill="#ffffff"/></svg>
            <p>Later</p>
            <button id="laterHideButton"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.22 15.53a.75.75 0 0 0 1.06 0L12 8.81l6.72 6.72a.75.75 0 1 0 1.06-1.06l-7.25-7.25a.75.75 0 0 0-1.06 0l-7.25 7.25a.75.75 0 0 0 0 1.06Z" fill="#ffffff"/></svg></button>
        </div>
        <div id="laterTasks" class="taskListContainerTasks">

        </div>
    </div>
    <div>
        <div class="taskListTitleContainer taskListTitleContainerGreen">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2Zm0 1.5a8.5 8.5 0 1 0 0 17 8.5 8.5 0 0 0 0-17Zm-1.25 9.94 4.47-4.47a.75.75 0 0 1 1.133.976l-.073.084-5 5a.75.75 0 0 1-.976.073l-.084-.073-2.5-2.5a.75.75 0 0 1 .976-1.133l.084.073 1.97 1.97 4.47-4.47-4.47 4.47Z" fill="#ffffff"/></svg>
            <p>Completed</p>
            <button id="completedHideButton"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.22 15.53a.75.75 0 0 0 1.06 0L12 8.81l6.72 6.72a.75.75 0 1 0 1.06-1.06l-7.25-7.25a.75.75 0 0 0-1.06 0l-7.25 7.25a.75.75 0 0 0 0 1.06Z" fill="#ffffff"/></svg></button>
        </div>
        <div id="completedTasks" class="taskListContainerTasks">

        </div>
    </div>
</div>
<template id="taskTemplate">
    <a href="#" class="taskContainerLink">
        <span class="taskStatus">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7 12.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0Zm.75 2.25a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM7 18.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0Zm3.75-6.75a.75.75 0 0 0 0 1.5h5.5a.75.75 0 0 0 0-1.5h-5.5ZM10 15.25a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 0 1.5h-5.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h5.5a.75.75 0 0 0 0-1.5h-5.5Zm8.664-9.086-5.829-5.828a.493.493 0 0 0-.049-.04.626.626 0 0 1-.036-.03 2.072 2.072 0 0 0-.219-.18.652.652 0 0 0-.08-.044l-.048-.024-.05-.029c-.054-.031-.109-.063-.166-.087a1.977 1.977 0 0 0-.624-.138c-.02-.001-.04-.004-.059-.007A.605.605 0 0 0 12.172 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9.828a2 2 0 0 0-.586-1.414ZM18.5 20a.5.5 0 0 1-.5.5H6a.5.5 0 0 1-.5-.5V4a.5.5 0 0 1 .5-.5h6V8a2 2 0 0 0 2 2h4.5v10Zm-5-15.379L17.378 8.5H14a.5.5 0 0 1-.5-.5V4.621Z" fill="#ffffff"/></svg>
        </span>
        <span class="taskTitle">
            Task Title
        </span>
        <span class="taskDueDate">
            Due Date
        </span>
        <span class="feedbackTextTaskList">
            Feedback
        </span>
    </a>
</template>

<script>
    const userID = {{userID|tojson}}
    const taskTemplate = document.getElementById('taskTemplate');
    const missingTasks = document.getElementById('missingTasks');
    const thisWeekTasks = document.getElementById('thisWeekTasks');
    const laterTasks = document.getElementById('laterTasks');
    const completedTasks = document.getElementById('completedTasks');

    const missingHideButton = document.getElementById('missingHideButton');
    const thisWeekHideButton = document.getElementById('thisWeekHideButton');
    const laterHideButton = document.getElementById('laterHideButton');
    const completedHideButton = document.getElementById('completedHideButton');

    thisWeekHideButton.addEventListener('click', () => {
        thisWeekTasks.classList.toggle('taskListHidden');
        if (thisWeekTasks.style.maxHeight === '0px') {
            thisWeekTasks.style.maxHeight = '300px';

        } else {
            thisWeekTasks.style.maxHeight = '0px';
        }
    });

    missingHideButton.addEventListener('click', () => {
        missingTasks.classList.toggle('taskListHidden');
        if (missingTasks.style.maxHeight === '0px') {
            missingTasks.style.maxHeight = '300px';

        } else {
            missingTasks.style.maxHeight = '0px';
        }
    });

    laterHideButton.addEventListener('click', () => {
        laterTasks.classList.toggle('taskListHidden');
        if (laterTasks.style.maxHeight === '0px') {
            laterTasks.style.maxHeight = '300px';

        } else {
            laterTasks.style.maxHeight = '0px';
        }
    });

    completedHideButton.addEventListener('click', () => {
        completedTasks.classList.toggle('taskListHidden');
        if (completedTasks.style.maxHeight === '0px') {
            completedTasks.style.maxHeight = '300px';

        } else {
            completedTasks.style.maxHeight = '0px';
        }
    });

    function isWithinNext7Days(date) {
        const now = new Date();
        const sevenDaysLater = new Date();
        sevenDaysLater.setDate(now.getDate() + 7);

        return date >= now && date <= sevenDaysLater;
    }

    let missingTasksNum = 0
    let thisWeekTasksNum = 0
    let laterTasksNum = 0
    let completedTasksNum = 0
    Object.keys(usersClasses).forEach(key => {


        const classColor = usersClasses[key].classInfo.coverImage;

        Object.keys(usersClasses[key].tasks).forEach(task => {
            let taskInfo = usersClasses[key].tasks[task];
            const dueDate = new Date(taskInfo.taskDue);
            const currentDate = new Date();

            currentDate.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            
            var missing = currentDate > dueDate;
            var thisWeek = isWithinNext7Days(dueDate);
            var later = currentDate < dueDate;
            status = "notComplete";
            var studentData = taskInfo.student_data;
            if (Object.keys(studentData).includes("{{userID}}")){
                status = studentData["{{userID}}"].status;
            }else{
                status = "notComplete";
            }

            const taskElement = taskTemplate.content.cloneNode(true);
            taskElement.querySelector('.taskContainerLink').href = "/task/"+key+ "/" + taskInfo.id;
            taskElement.querySelector('.taskTitle').innerText = taskInfo.taskName;
            taskElement.querySelector('.taskDueDate').innerText = taskInfo.taskDue;
            taskElement.querySelector('.taskStatus').classList.add("taskColor" + classColor);
            if(status == "completed"){
                completedTasksNum += 1;

                taskElement.querySelector('.taskDueDate').style.display = "none";
                if (studentData["{{userID}}"].feedback != ""){
                    taskElement.querySelector('.feedbackTextTaskList').style.display = "flex";
                }
                completedTasks.appendChild(taskElement);
            }else if(missing){
                missingTasksNum += 1;
                missingTasks.appendChild(taskElement);
            }else if(thisWeek){
                thisWeekTasksNum += 1;
                thisWeekTasks.appendChild(taskElement);
            }else if(later){
                laterTasksNum += 1;
                laterTasks.appendChild(taskElement);
            }
        })

});

if(missingTasksNum == 0){
    missingTasks.style.display = "none";
    missingHideButton.style.display = "none";
}
if(thisWeekTasksNum === 0){
    thisWeekTasks.style.display = "none";
    thisWeekHideButton.style.display = "none";
}
if(laterTasksNum === 0){
    laterTasks.style.display = "none";
    laterHideButton.style.display = "none";
}
if(completedTasksNum === 0){
    completedTasks.style.display = "none";
    completedHideButton.style.display = "none";
}
</script>
<script src="{{ url_for('static', filename='javascript/aiTools/taskSummary.js') }}"></script>
{% endblock %}