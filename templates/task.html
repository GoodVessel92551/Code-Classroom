{% extends "base.html" %}
{% block title %}Code Classroom | Task{% endblock %}
{% block main %}

<div class="pageTitleDiv">
  <h1>Task</h1>
</div>
<main class="mainQuickCode">
  <div class="codeEditorWindow">
    <div class="codeEditorTopBar">
      <span>
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_156_2)">
            <path d="M7.12497 0.09L7.57497 0.19L7.93997 0.32L8.23497 0.47L8.45997 0.63L8.62997 0.8L8.75497 0.97L8.83497 1.135L8.88497 1.285L8.90497 1.415L8.91497 1.515L8.90997 1.58V4.25L8.88497 4.565L8.81997 4.84L8.71497 5.07L8.58497 5.26L8.43497 5.415L8.26997 5.54L8.09497 5.635L7.91997 5.705L7.75497 5.755L7.60497 5.79L7.47497 5.81L7.36997 5.82H4.38497L4.03997 5.845L3.74497 5.915L3.49497 6.025L3.28997 6.16L3.12497 6.32L2.98997 6.495L2.88997 6.675L2.81497 6.86L2.76497 7.035L2.72997 7.195L2.70997 7.33L2.69997 7.435V8.965H1.58497L1.47997 8.95L1.33997 8.915L1.17997 8.855L1.00497 8.765L0.824971 8.635L0.644971 8.455L0.469971 8.225L0.309971 7.93L0.169971 7.565L0.0649707 7.125L-0.0050293 6.6L-0.0300293 5.985L-2.92975e-05 5.375L0.0799707 4.855L0.199971 4.42L0.359971 4.065L0.539971 3.78L0.739971 3.56L0.949971 3.395L1.15997 3.275L1.35997 3.195L1.53997 3.145L1.69997 3.12L1.81997 3.115H1.89997L1.92997 3.12H6.00997V2.705H3.08997L3.08497 1.33L3.07497 1.145L3.09997 0.975L3.15497 0.82L3.23997 0.68L3.36497 0.55L3.51997 0.435L3.70997 0.335L3.92997 0.245L4.18497 0.17L4.47497 0.11L4.79497 0.06L5.14997 0.03L5.53497 0.01L5.95497 0L6.58997 0.025L7.12497 0.09ZM3.97497 1.08L3.85997 1.245L3.81997 1.45L3.85997 1.655L3.97497 1.825L4.13997 1.935L4.34497 1.98L4.54997 1.935L4.71497 1.825L4.82997 1.655L4.86997 1.45L4.82997 1.245L4.71497 1.08L4.54997 0.97L4.34497 0.925L4.13997 0.97L3.97497 1.08ZM10.52 3.055L10.66 3.085L10.82 3.145L10.995 3.235L11.175 3.37L11.355 3.545L11.53 3.78L11.69 4.075L11.83 4.44L11.935 4.88L12.005 5.4L12.03 6.015L12 6.63L11.92 7.15L11.8 7.58L11.64 7.935L11.46 8.22L11.26 8.445L11.05 8.61L10.84 8.73L10.64 8.81L10.46 8.855L10.3 8.88L10.18 8.89L10.1 8.885H5.98997V9.295H8.90997L8.91497 10.675L8.92497 10.855L8.89997 11.025L8.84497 11.18L8.75997 11.325L8.63497 11.45L8.47997 11.57L8.28997 11.67L8.06997 11.755L7.81497 11.83L7.52497 11.895L7.20497 11.94L6.84997 11.975L6.46497 11.995L6.04497 12L5.40997 11.98L4.87497 11.91L4.42497 11.81L4.05997 11.685L3.76497 11.535L3.53997 11.37L3.36997 11.2L3.24497 11.03L3.16497 10.865L3.11497 10.715L3.09497 10.59L3.08497 10.49L3.08997 10.425V7.755L3.11497 7.435L3.17997 7.165L3.28497 6.935L3.41497 6.745L3.56497 6.585L3.72997 6.465L3.90497 6.365L4.07997 6.295L4.24497 6.245L4.39497 6.215L4.52497 6.195L4.62997 6.185L4.69497 6.18H7.61497L7.95997 6.155L8.25497 6.085L8.50497 5.98L8.70997 5.84L8.87497 5.68L9.00997 5.505L9.10997 5.325L9.18497 5.145L9.23497 4.97L9.26997 4.81L9.28997 4.67L9.29997 4.565V3.035H10.345L10.415 3.04L10.52 3.055ZM7.28497 10.18L7.16997 10.345L7.12997 10.55L7.16997 10.755L7.28497 10.92L7.44997 11.035L7.65497 11.075L7.85997 11.035L8.02497 10.92L8.13997 10.755L8.17997 10.55L8.13997 10.345L8.02497 10.18L7.85997 10.065L7.65497 10.025L7.44997 10.065L7.28497 10.18Z" fill="#87B5FF"/>
            </g>
            <defs>
            <clipPath id="clip0_156_2">
            <rect width="12" height="12" fill="white"/>
            </clipPath>
            </defs>
            </svg>
        Python
      </span>
      <button class="codeEditorRunButton" id="runButton">
        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 5.274c0-1.707 1.826-2.792 3.325-1.977l12.362 6.726c1.566.853 1.566 3.101 0 3.953L8.325 20.702C6.826 21.518 5 20.432 5 18.726V5.274Z" fill="#ffffff"/></svg>
        Run
      </button>
    </div>
    <div id="editor"></div>
    <div class="editorBottonBar" id="editorBottomBar">Saved</div>
  </div>
<div class="leftPanelTaskPage">
    <div class="consoleWindow" id="consoleWindow">
        <div class="codeEditorTopBar">
          <span id="consoleButton">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m8.086 18.611 5.996-14.004a1 1 0 0 1 1.878.677l-.04.11-5.996 14.004a1 1 0 0 1-1.878-.677l.04-.11 5.996-14.004L8.086 18.61Zm-5.793-7.318 4-4a1 1 0 0 1 1.497 1.32l-.083.094L4.414 12l3.293 3.293a1 1 0 0 1-1.32 1.498l-.094-.084-4-4a1 1 0 0 1-.083-1.32l.083-.094 4-4-4 4Zm14-4.001a1 1 0 0 1 1.32-.083l.093.083 4.001 4.001a1 1 0 0 1 .083 1.32l-.083.095-4.001 3.995a1 1 0 0 1-1.497-1.32l.084-.095L19.584 12l-3.293-3.294a1 1 0 0 1 0-1.414Z" fill="#ffffff"/></svg>
            Console
          </span>
          <span id="feedbackButton" class="feedbackButtonNotSelected">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13.75 2a2.25 2.25 0 0 1 2.245 2.096L16 4.25c0-.085-.005-.168-.014-.25h1.764A2.25 2.25 0 0 1 20 6.25v13.5A2.25 2.25 0 0 1 17.75 22H6.25A2.25 2.25 0 0 1 4 19.75V6.25A2.25 2.25 0 0 1 6.25 4h1.764c-.007.058-.01.117-.013.176L8 4.25A2.25 2.25 0 0 1 10.25 2h3.5Zm0 4.5h-3.5a2.248 2.248 0 0 1-1.892-1.033l.021.033H6.25a.75.75 0 0 0-.75.75v13.5c0 .414.336.75.75.75h11.5a.75.75 0 0 0 .75-.75V6.25a.75.75 0 0 0-.75-.75h-2.129l.021-.033A2.248 2.248 0 0 1 13.75 6.5Zm0-3h-3.5a.75.75 0 0 0 0 1.5h3.5a.75.75 0 0 0 0-1.5ZM8 14.5h4a.75.75 0 0 0 0-1.5H8a.75.75 0 0 0 0 1.5Zm0-4h8A.75.75 0 0 0 16 9H8a.75.75 0 0 0 0 1.5Zm0 8h6a.75.75 0 0 0 0-1.5H8a.75.75 0 0 0 0 1.5Z" fill="#fff"/></svg>
            Feedback
          </span>
          <button class="codeEditorClear" id="clearConsole">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.5 6a1 1 0 0 1-.883.993L20.5 7h-.845l-1.231 12.52A2.75 2.75 0 0 1 15.687 22H8.313a2.75 2.75 0 0 1-2.737-2.48L4.345 7H3.5a1 1 0 0 1 0-2h5a3.5 3.5 0 1 1 7 0h5a1 1 0 0 1 1 1Zm-7.25 3.25a.75.75 0 0 0-.743.648L13.5 10v7l.007.102a.75.75 0 0 0 1.486 0L15 17v-7l-.007-.102a.75.75 0 0 0-.743-.648Zm-4.5 0a.75.75 0 0 0-.743.648L9 10v7l.007.102a.75.75 0 0 0 1.486 0L10.5 17v-7l-.007-.102a.75.75 0 0 0-.743-.648ZM12 3.5A1.5 1.5 0 0 0 10.5 5h3A1.5 1.5 0 0 0 12 3.5Z" fill="#ffffff"/></svg>
            Clear
          </button>
          <button style="display: none;" class="saveFeedback" id="saveFeedback">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.75 3h-1A2.75 2.75 0 0 0 3 5.75v12.5A2.75 2.75 0 0 0 5.75 21H6v-6a2.25 2.25 0 0 1 2.25-2.25h7.5A2.25 2.25 0 0 1 18 15v6h.25A2.75 2.75 0 0 0 21 18.25V8.286a3.25 3.25 0 0 0-.952-2.299l-2.035-2.035A3.25 3.25 0 0 0 15.75 3v4.5a2.25 2.25 0 0 1-2.25 2.25H9A2.25 2.25 0 0 1 6.75 7.5V3Z" fill="#fff"/><path d="M14.25 3v4.5a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75V3h6ZM16.5 21v-6a.75.75 0 0 0-.75-.75h-7.5a.75.75 0 0 0-.75.75v6h9Z" fill="#fff"/></svg>
            Save
          </button>
        </div>
    
        <p id="consoleText" class="consoleText"></p>
        <input style="display: none;" id="consoleInput" type="text" placeholder="Type here and press Enter" />
      <div class="feedbackWindow" id="feedbackWindow">
        <textarea maxlength="1000" placeholder="Your Feedback" id="feedbackText"></textarea>
        <div class="containerWithNumber" id="pointsContainer">
          <div class="containerWithNumberTextContainer">
              <h3>Points</h3>
              <p id="pointsText">Select the score of this task. 0 - {{task["taskPoints"]}}</p>
          </div>
          <input type="number" id="taskPoints" name="taskPoints" value="100" min="0" max="{{task['taskPoints']}}" oninput="this.value = Math.min(Math.max(0, this.value), {{task['taskPoints']}})">
            </div>
      <div id="feedbackSavedText" class="errorBarFeedback">
        Saved
      </div>
      </div>
      </div>
      <div class="instructionWindow" id="instructionWindow">
        <div class="instructionWindowTopBar">
            <img id="taskImage" src="/static/coverImages/classroomBanners/{{class_color}}Gradient.webp">
            <h2>Task Info</h2>
            <div class="pills">
                <a href="/classroom/{{classid}}"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.25 2A2.75 2.75 0 0 1 20 4.75V19.25a2.75 2.75 0 0 1-2.75 2.75H6.75A2.75 2.75 0 0 1 4 19.249V4.75c0-1.26.846-2.32 2-2.647V3.75c-.304.228-.5.59-.5 1v14.498c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25V4.75c0-.69-.56-1.25-1.25-1.25L15 3.5V2h2.25ZM14 2v8.139c0 .747-.8 1.027-1.29.764l-.082-.052-2.126-1.285-2.078 1.251c-.5.36-1.33.14-1.417-.558L7 10.14V2h7Zm-1.5 1.5h-4v5.523l1.573-.949a.923.923 0 0 1 .818-.024l1.61.974V3.5Z" fill="#ffffff"/></svg>Back to Class</a>
              <button id="completeButton"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.53 12.97a.75.75 0 0 0-1.06 1.06l4.5 4.5a.75.75 0 0 0 1.06 0l11-11a.75.75 0 0 0-1.06-1.06L8.5 16.94l-3.97-3.97Z" fill="#fff"/></svg>Submit</button>
              </div>
        </div>
        <div class="instructionWindowContent" id="instructionWindowContent">
          <zero-md class="markdown">
            <template data-append>
              <link type="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
              <link type="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11/styles/github-dark.min.css">
              <style>
                  .markdown-body {
                      padding: 0px !important;
                      box-sizing: border-box !important;
                      border-radius: 16px !important;
                      height: auto !important;
                      width: auto !important;
                      background-color: transparent  !important;
                      border: 1px solid transparent  !important;
                      font-family: "Lexend", sans-serif !important;
                      background-color: #1c202b !important;
                  }
                  .markdown-body > pre {
                      background-color: #32394b;
                      border-radius: 16px;
                  }
                  .markdown-body code:not(pre > code) {
                      background-color: #32394b;
                      border-radius: 16px;
                      color:#e7b9a2;
                  }
              </style>
            </template>
            <script type="text/markdown" id="taskDescription">
            </script>
          </zero-md>
        </div>
      </div>
</div>
</main>

<script>
  const consoleButton = document.getElementById('consoleButton');
  const feedbackButton = document.getElementById('feedbackButton');
  const consoleWindow = document.getElementById('consoleWindow');
  const consoleText = document.getElementById('consoleText');
  const feedbackWindow = document.getElementById('feedbackWindow');
  const feedbackSavedText = document.getElementById('feedbackSavedText');
  const saveFeedback = document.getElementById('saveFeedback');
  const feedbackText = document.getElementById('feedbackText')
  const taskPoints = document.getElementById('taskPoints')
  const pointsContainer = document.getElementById('pointsContainer')
  const pointsText = document.getElementById('pointsText')
  const completeButton = document.getElementById('completeButton');
  const instructionWindow = document.getElementById('instructionWindow');
  const instructionWindowContent = document.getElementById('instructionWindowContent');
  const taskDescription = document.getElementById('taskDescription');
  const taskImage = document.getElementById('taskImage');
  const teacher = {{teacher|tojson}};
  const classColor = {{class_color|tojson}};
  const task = {{task|tojson}};
  const classid = {{classid|tojson}};
  const taskid = {{taskid|tojson}};
  const loadedTaskCode = {{code|tojson}};
  const userid = {{userid|tojson}};
  const studentTask = task.student_data[userid]
  if(!teacher){
    feedbackText.disabled = true;
    feedbackSavedText.style.display = 'none';
    if(studentTask.status == "completed"){
      completeButton.style.display = 'none';
    }
    if(studentTask.feedback == ""){
      feedbackText.placeholder = "No feedback yet";
    } else {
      feedbackText.value = studentTask.feedback;
    }

    if(studentTask.points){
      taskPoints.value = studentTask.points;
      taskPoints.disabled = true;
      pointsText.textContent = "This is the amount of points that this task received";
    }else{
      pointsContainer.style.display = 'none';
    }
  }else if (teacher){
    if(studentTask.feedback != ""){
      feedbackText.value = studentTask.feedback;
    }
    if(task.taskPoints){
      taskPoints.value = studentTask.points;
    }else{
      pointsContainer.style.display = 'none';
    }
  }

  feedbackWindow.addEventListener('input', () => {
    feedbackSavedText.textContent = "Not Saved";
  });





  const switchToConsole = () => {
    saveFeedback.style.display = 'none';
    clearConsole.style.display = 'flex';
    consoleText.style.display = 'flex';
    feedbackWindow.style.display = 'none';
    feedbackButton.classList.add('feedbackButtonNotSelected');
    consoleButton.classList.remove('feedbackButtonNotSelected');
  }

  const switchToFeedback = () => {
    if(teacher){
      saveFeedback.style.display = 'flex';
    }
    clearConsole.style.display = 'none';
    consoleText.style.display = 'none';
    feedbackWindow.style.display = 'flex';
    feedbackButton.classList.remove('feedbackButtonNotSelected');
    consoleButton.classList.add('feedbackButtonNotSelected');
  }

  consoleButton.addEventListener('click', () => {
    switchToConsole()
  });

  feedbackButton.addEventListener('click', () => {
    switchToFeedback()
  });

  saveFeedback.addEventListener("click", () => {
    const data = {
      feedback: feedbackText.value,
      points: taskPoints.value,
      classid: classid,
      taskid: taskid,
      userid: userid
    }
    fetch(`/endpoint/task/feedback`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success:', data);
      if ( data.status == "complete"){
        feedbackSavedText.textContent = "Saved";
      }else{
        feedbackSavedText.textContent = data.status;
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  });

  


  if (teacher) {
    document.getElementById('completeButton').style.display = 'none';
    instructionWindow.style.display = 'none';
  }else{
    instructionWindow.style.display = 'flex';
  consoleWindow.style.minHeight = "50%";
  taskDescription.textContent = task.taskDescription;
  }
  completeButton.addEventListener('click', () => {
    saveCode()
    window.location.href = `/endpoint/task/complete/${classid}/${taskid}`;
  });
</script>

<!-- Load require.js (for Monaco) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>

<!-- Include Skulpt (and its stdlib) -->
<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

<script src="{{ url_for('static', filename='javascript/codeEditor.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/aiTools/weakTopics.js') }}"></script>

{% endblock %}
